<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rastrear publicaci√≥n de enlace</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 1200px; margin: 0 auto; }
    label, input { display: block; margin: .5rem 0; }
    input[type="text"] { width: 100%; max-width: 600px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    button { padding: 10px 20px; background: #007cba; color: white; border: none; cursor: pointer; border-radius: 4px; }
    button:hover { background: #005a87; }
    progress { width: 100%; height: 20px; display: none; margin-top: 1rem; }
    #estado { margin-top: .5rem; font-weight: bold; color: #333; }
    #resultado { margin-top: 2rem; }
    .encontrado { color: green; font-weight: bold; }
    .no-encontrado { color: red; font-weight: bold; }
    ul { list-style: none; padding: 0; }
    a:hover { text-decoration: underline !important; }
  </style>
</head>
<body>
  <h1>Rastrear d√≥nde fue publicado un enlace</h1>

  <form id="formulario">
    <label for="site">Sitio a escanear:</label>
    <input size="80" type="text" id="site" name="site" value="https://www.cfn.fin.ec" required>

    <label for="target">Enlace a rastrear:</label>
    <input size="80" type="text" id="target" name="target"
      placeholder="https://www.cfn.fin.ec/wp-content/uploads/2014/07/‚Ä¶"
      required>

    <button type="submit">Iniciar escaneo</button>
  </form>

  <progress id="barra" max="1" value="0"></progress>
  <div id="estado"></div>
  <div id="resultado"></div>

  <script>
    const form = document.getElementById("formulario");
    const barra = document.getElementById("barra");
    const estado = document.getElementById("estado");
    const resultado = document.getElementById("resultado");

    form.addEventListener("submit", async e => {
      e.preventDefault();
      // reiniciar UI
      barra.style.display = "block";
      barra.value = 0;
      barra.max = 1;
      estado.textContent = "";
      resultado.innerHTML = "";

      // arrancar el crawler
      const fd = new FormData(form);
      await fetch("/iniciar", { method: "POST", body: fd });

      // iniciar loop de progreso y resultados en tiempo real
      const loop = setInterval(async () => {
        // Obtener progreso
        const resp = await fetch("/progreso");
        const js = await resp.json();
        barra.max = js.total || 1;
        barra.value = js.actual;
        estado.textContent = `${js.actual} de ${js.total} p√°ginas escaneadas`;

        // Obtener resultados parciales en tiempo real
        try {
          const r2 = await fetch("/resultados-parciales");
          const hits = await r2.json();
          
          console.log("Resultados recibidos:", hits); // Para debug
          
          // Mostrar resultados en tiempo real
          if (hits.length > 0) {
            resultado.innerHTML = `<p class="encontrado">‚úÖ Enlaces encontrados: ${hits.length}</p><ul>` +
              hits.map(h => {
                // Manejar diferentes estructuras de datos
                const pagina = h.url || h.pagina || h.pagina_donde_se_encontro || 'P√°gina desconocida';
                const metodo = h.type || h.metodo || h.metodo_encontrado || 'Detectado';
                const enlaceOriginal = h.original_link || h.enlace_original || h.enlace_publicado || h.link || 'No disponible';
                const enlaceFinal = h.final_url || h.enlace_final || enlaceOriginal;
                
                return `<li style="margin-bottom: 15px; padding: 12px; background: #f0f8f0; border-left: 4px solid green; border-radius: 4px;">
                          <strong>üìÑ Encontrado en:</strong><br>
                          <a href="${pagina}" target="_blank" style="color: #007cba; text-decoration: none;">
                            ${pagina}
                          </a><br><br>
                          <strong>üîç M√©todo de detecci√≥n:</strong> ${metodo}<br><br>
                          <strong>üîó Enlace publicado:</strong><br>
                          <a href="${enlaceOriginal}" target="_blank" style="color: #007cba; text-decoration: none;">
                            ${enlaceOriginal}
                          </a><br>
                          ${enlaceFinal !== enlaceOriginal ? 
                            `<br><strong>‚û°Ô∏è Redirige a:</strong><br>
                             <a href="${enlaceFinal}" target="_blank" style="color: #007cba; text-decoration: none;">
                               ${enlaceFinal}
                             </a>` : 
                            ''}
                        </li>`;
              }).join("") +
              `</ul>`;
          } else {
            // Solo mostrar "buscando..." si el crawler sigue activo
            if (js.crawling_active) {
              resultado.innerHTML = `<p style="color: #666;">üîç Buscando... a√∫n no se han encontrado resultados.</p>`;
            }
          }
        } catch (e) {
          console.error("Error obteniendo resultados parciales:", e);
        }

        // Si termin√≥ el crawling
        if (!js.crawling_active) {
          clearInterval(loop);
          
          // Obtener resultados finales
          try {
            const r3 = await fetch("/resultados");
            const finalHits = await r3.json();
            
            if (finalHits.length === 0) {
              resultado.innerHTML = `<p class="no-encontrado">‚ùå Escaneo completado. No se encontr√≥ el enlace en ninguna de las ${js.total} p√°ginas escaneadas.</p>`;
            } else {
              // Actualizar con mensaje final
              resultado.innerHTML = resultado.innerHTML.replace(
                `‚úÖ Enlaces encontrados: ${finalHits.length}`,
                `‚úÖ Escaneo completado! Enlaces encontrados: ${finalHits.length} en ${js.total} p√°ginas escaneadas`
              );
            }
          } catch (e) {
            console.error("Error obteniendo resultados finales:", e);
            resultado.innerHTML = `<p class="no-encontrado">‚ùå Escaneo completado. Error al obtener resultados finales.</p>`;
          }
        }
      }, 1000);
    });
  </script>
</body>
</html>
