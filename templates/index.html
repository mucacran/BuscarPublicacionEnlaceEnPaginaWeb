<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Buscar publicaci√≥n del enlace</title>
    <style>
        progress { width: 100%; height: 20px; }
        .encontrado { color: green; font-weight: bold; }
        .no-encontrado { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Rastrear d√≥nde fue publicado un enlace</h1>
    <form onsubmit="iniciarBusqueda(event)">
        <label>Sitio a escanear:</label><br>
        <input type="text" id="site" size="60" placeholder="https://www.ejemplo.com" required><br><br>
        <label>Enlace a rastrear:</label><br>
        <input type="text" id="target" required placeholder="https://www.cfn.fin.ec/ruta/al/archivo.pdf"><br>
        <small style="color: #666;">üí° El sistema buscar√° el enlace exacto, nombre del archivo y enlaces que redirijan al archivo</small><br><br>
        <button type="submit">Iniciar escaneo</button>
    </form>

    <br>
    <progress id="barra" value="0" max="100"></progress>
    <p id="estado"></p>
    <button id="detenerBtn" style="display:none; background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;" onclick="detenerEscaneo()">Detener Escaneo</button>
    
    <!-- √Årea para mostrar resultados en tiempo real -->
    <div id="resultados-tiempo-real" style="margin-top: 20px;">
        <h3 id="contador-resultados" style="display:none;">Enlaces encontrados: <span id="num-encontrados">0</span></h3>
        <div id="lista-resultados"></div>
    </div>
    
    <div id="resultado"></div>

    <script>
        let intervalId = null;
        
        async function iniciarBusqueda(event) {
            event.preventDefault();
            document.getElementById("resultado").innerHTML = "";
            document.getElementById("lista-resultados").innerHTML = "";
            document.getElementById("contador-resultados").style.display = "none";
            const site = document.getElementById("site").value;
            const target = document.getElementById("target").value;
            
            // Mostrar bot√≥n de detener
            document.getElementById("detenerBtn").style.display = "inline-block";

            await fetch("/iniciar", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `site=${encodeURIComponent(site)}&target=${encodeURIComponent(target)}`
            });

            const barra = document.getElementById("barra");
            const estado = document.getElementById("estado");

            intervalId = setInterval(async () => {
                const r = await fetch("/progreso");
                const data = await r.json();
                barra.max = data.total;
                barra.value = data.actual;
                estado.innerText = `${data.actual} de ${data.total} p√°ginas escaneadas`;

                // Obtener resultados parciales
                const resParcialesRes = await fetch("/resultados-parciales");
                const resParcialesData = await resParcialesRes.json();
                
                // Mostrar contador si hay resultados
                const contadorResultados = document.getElementById("contador-resultados");
                const numEncontrados = document.getElementById("num-encontrados");
                const listaResultados = document.getElementById("lista-resultados");
                
                if (resParcialesData.total_encontrados > 0) {
                    contadorResultados.style.display = "block";
                    numEncontrados.textContent = resParcialesData.total_encontrados;
                    
                    // Actualizar la lista de resultados
                    listaResultados.innerHTML = resParcialesData.resultados.map(url => `
                        <div class='resultado-item' style='margin: 10px 0; padding: 10px; background-color: #e8f5e8; border-left: 4px solid #28a745; border-radius: 4px;'>
                            <span style='color: #28a745; font-weight: bold;'>‚úÖ Encontrado en:</span><br>
                            <a href='${url}' target='_blank' style='word-break: break-all;'>${url}</a>
                        </div>
                    `).join('');
                }

                // Verificar si el crawler sigue activo
                const estadoRes = await fetch("/estado");
                const estadoData = await estadoRes.json();
                
                // Solo terminar cuando el crawler est√© inactivo
                if (!estadoData.crawling_active) {
                    clearInterval(intervalId);
                    document.getElementById("detenerBtn").style.display = "none";
                    
                    const div = document.getElementById("resultado");
                    if (resParcialesData.total_encontrados > 0) {
                        div.innerHTML = `<p class="encontrado">üéâ Escaneo completado. Se encontr√≥ el enlace en ${resParcialesData.total_encontrados} p√°gina(s) de un total de ${data.actual} p√°ginas escaneadas.</p>`;
                    } else {
                        div.innerHTML = `<p class="no-encontrado">‚ùå Escaneo completado. No se encontr√≥ el enlace en ninguna de las ${data.actual} p√°ginas escaneadas.</p>`;
                    }
                    estado.innerText = `Escaneo completado: ${data.actual} de ${data.total} p√°ginas escaneadas`;
                }
            }, 1000);
        }
        
        async function detenerEscaneo() {
            if (intervalId) {
                clearInterval(intervalId);
            }
            
            await fetch("/detener", {
                method: "POST"
            });
            
            document.getElementById("detenerBtn").style.display = "none";
            document.getElementById("estado").innerText += " (Detenido por el usuario)";
        }
    </script>
</body>
</html>
