<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Rastrear publicación de enlace</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    label, input { display: block; margin: .5rem 0; }
    progress { width: 100%; height: 20px; display: none; margin-top: 1rem; }
    #estado { margin-top: .5rem; }
    #resultado { margin-top: 2rem; }
    .encontrado { color: green; font-weight: bold; }
    .no-encontrado { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Rastrear dónde fue publicado un enlace</h1>

  <form id="formulario">
    <label for="site">Sitio a escanear:</label>
    <input type="text" id="site" name="site" value="https://www.cfn.fin.ec" required>

    <label for="target">Enlace a rastrear:</label>
    <input type="text" id="target" name="target"
      placeholder="https://www.cfn.fin.ec/wp-content/uploads/2014/07/…"
      required>

    <button type="submit">Iniciar escaneo</button>
  </form>

  <progress id="barra" max="1" value="0"></progress>
  <div id="estado"></div>
  <div id="resultado"></div>

  <script>
    const form = document.getElementById("formulario");
    const barra = document.getElementById("barra");
    const estado = document.getElementById("estado");
    const resultado = document.getElementById("resultado");

    form.addEventListener("submit", async e => {
      e.preventDefault();
      // reiniciar UI
      barra.style.display = "block";
      barra.value = 0;
      barra.max = 1;
      estado.textContent = "";
      resultado.innerHTML = "";

      // arrancar el crawler
      const fd = new FormData(form);
      await fetch("/iniciar", { method: "POST", body: fd });

      // iniciar loop de progreso
      const loop = setInterval(async () => {
        const resp = await fetch("/progreso");
        const js = await resp.json();
        barra.max = js.total || 1;
        barra.value = js.actual;
        estado.textContent = `${js.actual} de ${js.total} páginas escaneadas`;

        if (!js.crawling_active) {
          clearInterval(loop);
          // cuando termine, pedir resultados
          const r2 = await fetch("/resultados");
          const hits = await r2.json();
          if (hits.length) {
            resultado.innerHTML = `<p class="encontrado">✅ Enlace encontrado en:</p><ul>` +
              hits.map(h => `<li><a href="${h.pagina_donde_se_encontro}" target="_blank">
                               ${h.pagina_donde_se_encontro}</a>  
                              [${h.metodo_encontrado}]  
                              (<a href="${h.enlace_publicado}" target="_blank">
                                 ${new URL(h.enlace_publicado).pathname.split('/').pop()}
                               </a>)
                             </li>`)
                   .join("") +
              `</ul>`;
          } else {
            resultado.innerHTML = `<p class="no-encontrado">❌ No se encontró el enlace en el sitio.</p>`;
          }
        }
      }, 1000);
    });
  </script>
</body>
</html>
